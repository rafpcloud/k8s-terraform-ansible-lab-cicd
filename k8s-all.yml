---
  - name: UAU
    hosts: all
    remote_user: ec2-user
    become: yes
    become_method: sudo
    become_user: root
    gather_facts: yes
  
    tasks:
      - name: Add repo 
        command: wget -O /etc/yum.repos.d/kubernetes.repo  https://raw.githubusercontent.com/rafpcloud/k8s-the-hard-way/main/kubernetes.repo
        register: mymotd
   
      - name: Cria o usurio k8sadm
        user: name=k8sadm append=yes state=present createhome=yes shell=/bin/bash 

      - name: Configura sudooers para o k8sadm
        lineinfile:
          dest: /etc/sudoers
          line: 'k8sadm ALL=(ALL) NOPASSWD: ALL'
          validate: 'visudo -cf %s'

      - name: Configurar a troca de chaves
        authorized_key: user=k8sadm key="{{item}}"
        with_file:
          - ~/.ssh/id_rsa.pub

      - name: Desabilita o swap
        shell: |
               sudo swapoff -a
               sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

      - name: Desabilita o  Selinux
        shell: | 
               sudo setenforce 0
               sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config 

      - name: Adicionar parametros do iptables no sysctl
        shell: |
               cat <<EOF > /etc/sysctl.d/k8s.conf
               net.bridge.bridge-nf-call-ip6tables = 1
               net.bridge.bridge-nf-call-iptables = 1
               EOF
      
      - name: Reload
        shell:  sysctl --system       
            
      - name: Instala os pacotes do k8s 
        yum:
          name: '{{ item }}'
          state: present
          update_cache: True
        with_items:
          - kubelet
          - kubeadm
          - kubectl
          - docker 
          - tc

      - name: Habilita e Inicia os servicos    
        shell:  systemctl enable kubelet ;  systemctl start kubelet ;  systemctl enable docker ;  systemctl start docker




